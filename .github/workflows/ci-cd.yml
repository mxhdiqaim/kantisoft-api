name: CI/CD Pipeline - Build, Test, Push & Deploy

on:
  push:
    branches:
      - master # Using master as you specified, but recommend changing to main

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  # -------------------------------------
  #               CI JOB
  # -------------------------------------
  build-and-test:
    name: Build, Lint, and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Check (tsc)
        run: pnpm run build

      - name: Run Linting
        run: pnpm run lint

      # - name: Run Unit Tests
      #   run: pnpm run test

  # ------------------------------------------------------------
  #             DOCKER PUSH JOB (Depends on CI job)
  # ------------------------------------------------------------
  build-and-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest

    needs: build-and-test

    # -----------------------------------------------------------
    #           DEPLOY JOB (Depends on the PUSH job)
    # -----------------------------------------------------------
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-push # Waits for the image to be successfully pushed

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üöÄ Deploy via SSH and Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_PATH="/root/kantisoft" 
            echo "Navigating to deployment directory..."
            cd $DEPLOY_PATH
            
            echo "Pulling latest image for 'api' service..."
            docker compose -f docker-compose.prod.yml pull api 
            
            echo "Starting new container version..."
            docker compose -f docker-compose.prod.yml up -d api
            
            echo "Deployment finished for api service!"